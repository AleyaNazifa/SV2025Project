import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime
import pytz

# Page configuration
st.set_page_config(
    page_title="Member 3 Analysis",
    page_icon="ğŸ‘¤",
    layout="wide"
)

# Custom CSS - Professional styling
st.markdown("""
    <style>
    [data-testid="stSidebar"] {
        background: linear-gradient(180deg, #4c1d95 0%, #5b21b6 50%, #6d28d9 100%);
    }
    [data-testid="stSidebar"] * {
        color: white !important;
    }
    h1 {
        color: #4c1d95;
        font-weight: 800;
        padding-bottom: 1rem;
        border-bottom: 4px solid #8b5cf6;
    }
    h2 {
        color: #5b21b6;
        font-weight: 700;
    }
    .stButton>button {
        background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        color: white;
        font-weight: 600;
    }
    </style>
""", unsafe_allow_html=True)

# Google Sheets CSV URL
CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSf4umx6QNDel99If8P2otizAHj7jEDxFIsqandbD0zYVzfDheZo2YVkK1_zknpDKjHnBuYWCINgcCe/pub?output=csv"

# Load data
@st.cache_data(ttl=300)
def load_data():
    try:
        df = pd.read_csv(CSV_URL)
        return df
    except Exception as e:
        st.error(f"Error loading data: {e}")
        return None

def get_malaysian_time():
    malaysia_tz = pytz.timezone('Asia/Kuala_Lumpur')
    return datetime.now(malaysia_tz)

df = load_data()

# Sidebar navigation
with st.sidebar:
    st.markdown("### ğŸ§­ Quick Navigation")
    col1, col2 = st.columns(2)
    with col1:
        if st.button("ğŸ  Home", use_container_width=True):
            st.switch_page("app.py")
    with col2:
        if st.button("ğŸ”„ Refresh", use_container_width=True):
            st.cache_data.clear()
            st.rerun()
    
    st.markdown("---")
    my_time = get_malaysian_time()
    st.info(f"ğŸ• {my_time.strftime('%H:%M:%S')} MYT\nğŸ“… {my_time.strftime('%d %B %Y')}")

# Page Header
st.title("ğŸ‘¤ Member 3: Lifestyle Factors & Sleep Habits Analysis")
st.markdown("### ğŸƒ Investigating Behavioral and Environmental Influences on Sleep")
st.markdown("---")

if df is not None:
    # Visualization 1: Electronic Device Usage
    st.markdown("## ğŸ“Š Visualization 1: Electronic Device Usage Before Sleep")
    st.markdown("*Screen time habits before bedtime and their prevalence*")
    
    col1, col2 = st.columns([3, 2])
    
    with col1:
        device_counts = df['How often do you use electronic devices (e.g., phone, computer) before going to sleep? '].value_counts()
        fig1 = px.pie(
            values=device_counts.values, 
            names=device_counts.index,
            title="Electronic Device Usage Before Bedtime",
            color_discrete_sequence=['#8b5cf6', '#a78bfa', '#c4b5fd', '#ddd6fe', '#ede9fe'],
            hole=0.4
        )
        fig1.update_traces(textposition='inside', textinfo='percent+label', textfont_size=13)
        fig1.update_layout(height=500)
        st.plotly_chart(fig1, use_container_width=True)
    
    with col2:
        st.markdown("### ğŸ“± Usage Patterns")
        st.markdown("---")
        for category, count in device_counts.items():
            percentage = (count / len(df)) * 100
            if "Always" in category or "every night" in category:
                st.error(f"**{category}**\n\n{count} students\n({percentage:.1f}%)")
            elif "Often" in category or "Frequently" in category:
                st.warning(f"**{category}**\n\n{count} students\n({percentage:.1f}%)")
            else:
                st.success(f"**{category}**\n\n{count} students\n({percentage:.1f}%)")
    
    with st.expander("ğŸ’¡ Why This Matters - Blue Light Impact"):
        st.write("""
        ğŸ“± **Screen Time Effects on Sleep:**
        - Blue light suppresses melatonin production by up to 50%
        - Delays sleep onset by an average of 30-60 minutes
        - Reduces REM sleep quality and overall sleep duration
        - Associated with increased insomnia symptoms
        
        ğŸ”¬ **Recommendation:** Avoid screens 1-2 hours before bedtime for optimal sleep quality.
        """)
    
    st.markdown("---")
    
    # Visualization 2: Caffeine Consumption
    st.markdown("## ğŸ“Š Visualization 2: Caffeine Consumption Patterns")
    st.markdown("*How often students consume caffeine to stay awake or alert*")
    
    caffeine_counts = df['How often do you consume caffeine (coffee, energy drinks) to stay awake or alert? '].value_counts()
    
    fig2 = px.bar(
        x=caffeine_counts.index, 
        y=caffeine_counts.values,
        title="Caffeine Consumption Frequency Among Students",
        color=caffeine_counts.values,
        color_continuous_scale='Oranges',
        labels={'x': 'Frequency', 'y': 'Number of Students'}
    )
    fig2.update_layout(height=500, showlegend=False, xaxis_tickangle=-15)
    fig2.update_traces(texttemplate='%{y}', textposition='outside')
    st.plotly_chart(fig2, use_container_width=True)
    
    st.markdown("### â˜• Caffeine Consumption Summary")
    col1, col2, col3 = st.columns(3)
    with col1:
        high_caffeine = caffeine_counts.get('Always (every night)', 0) + caffeine_counts.get('Often (5â€“6 times a week)', 0)
        pct = (high_caffeine / len(df)) * 100
        st.error(f"â˜• **High Users**\n\n{high_caffeine} students ({pct:.1f}%)\n\nDaily/Very Frequent")
    with col2:
        moderate_caffeine = caffeine_counts.get('Sometimes (3â€“4 times a week)', 0)
        pct = (moderate_caffeine / len(df)) * 100
        st.warning(f"â˜• **Moderate Users**\n\n{moderate_caffeine} students ({pct:.1f}%)\n\n3-4 times/week")
    with col3:
        low_caffeine = caffeine_counts.get('Rarely (1â€“2 times a week)', 0) + caffeine_counts.get('Never', 0)
        pct = (low_caffeine / len(df)) * 100
        st.success(f"â˜• **Low/No Users**\n\n{low_caffeine} students ({pct:.1f}%)\n\nRare or Never")
    
    st.markdown("---")
    
    # Visualization 3: Physical Activity
    st.markdown("## ğŸ“Š Visualization 3: Physical Activity & Exercise Frequency")
    st.markdown("*Regular exercise habits and their distribution among students*")
    
    exercise_counts = df['How often do you engage in physical activity or exercise? '].value_counts()
    
    # Create ordered categories
    order = ['Never', 'Rarely (1â€“2 times a week)', 'Sometimes (3â€“4 times a week)', 
             'Often (5â€“6 times a week)', 'Every day']
    exercise_ordered = exercise_counts.reindex([cat for cat in order if cat in exercise_counts.index], fill_value=0)
    
    fig3 = go.Figure()
    colors = ['#ef4444', '#f97316', '#fbbf24', '#84cc16', '#22c55e']
    
    fig3.add_trace(go.Bar(
        x=exercise_ordered.index,
        y=exercise_ordered.values,
        marker=dict(
            color=colors[:len(exercise_ordered)],
            line=dict(color='white', width=2)
        ),
        text=exercise_ordered.values,
        textposition='outside',
        textfont=dict(size=14)
    ))
    
    fig3.update_layout(
        title="Exercise Frequency Among UMK Students",
        xaxis_title="Frequency",
        yaxis_title="Number of Students",
        height=550,
        xaxis_tickangle=-30
    )
    st.plotly_chart(fig3, use_container_width=True)
    
    st.info("""
    **ğŸ’ª Exercise & Sleep Connection - Scientific Evidence:**
    
    Regular physical activity significantly improves sleep through multiple mechanisms:
    - â° **Regulates Circadian Rhythm**: Helps maintain consistent sleep-wake cycles
    - ğŸ˜Œ **Reduces Stress**: Lowers cortisol and anxiety levels
    - ğŸ˜´ **Promotes Deeper Sleep**: Increases slow-wave (deep) sleep stages
    - âš¡ **Faster Sleep Onset**: Reduces time to fall asleep by 10-15 minutes
    
    **Optimal Timing:** Exercise 4-6 hours before bedtime for best results.
    """)
    
    st.markdown("---")
    
    # Visualization 4: Stress Levels
    st.markdown("## ğŸ“Š Visualization 4: Academic Stress Levels")
    st.markdown("*Stress related to academic workload and its distribution*")
    
    col1, col2 = st.columns([2, 3])
    
    with col1:
        st.markdown("### ğŸ“Š Stress Distribution")
        st.markdown("---")
        stress_counts = df['How would you describe your stress levels related to academic workload? '].value_counts()
        
        for category, count in stress_counts.items():
            percentage = (count / len(df)) * 100
            st.write(f"**{category}**")
            
            if "Extremely high" in category or "Very high" in category:
                st.progress(percentage / 100, text=f"{percentage:.1f}%")
                st.error(f"ğŸ”´ {count} students - Critical")
            elif "High stress" in category:
                st.progress(percentage / 100, text=f"{percentage:.1f}%")
                st.warning(f"ğŸŸ  {count} students - High")
            elif "Moderate" in category:
                st.progress(percentage / 100, text=f"{percentage:.1f}%")
                st.info(f"ğŸŸ¡ {count} students - Moderate")
            else:
                st.progress(percentage / 100, text=f"{percentage:.1f}%")
                st.success(f"ğŸŸ¢ {count} students - Low")
            st.write("")
    
    with col2:
        fig4 = px.pie(
            values=stress_counts.values, 
            names=stress_counts.index,
            title="Stress Levels Related to Academic Workload",
            color_discrete_sequence=['#22c55e', '#84cc16', '#fbbf24', '#f97316', '#ef4444']
        )
        fig4.update_traces(textposition='auto', textinfo='percent+label', textfont_size=12)
        fig4.update_layout(height=500)
        st.plotly_chart(fig4, use_container_width=True)
    
    st.markdown("---")
    
    # Visualization 5: Sleep Methods
    st.markdown("## ğŸ“Š Visualization 5: Sleep Aid Methods Used by Students")
    st.markdown("*Techniques and methods students employ to improve their sleep quality*")
    
    methods_counts = df['Do you use any methods to help you sleep?'].value_counts()
    
    fig5 = px.bar(
        x=methods_counts.index, 
        y=methods_counts.values,
        title="Methods Used to Help Sleep",
        color=methods_counts.values,
        color_continuous_scale='Purples',
        labels={'x': 'Method', 'y': 'Number of Students'}
    )
    fig5.update_layout(
        height=550,
        xaxis_tickangle=-45,
        showlegend=False
    )
    fig5.update_traces(texttemplate='%{y}', textposition='outside')
    st.plotly_chart(fig5, use_container_width=True)
    
    # Methods breakdown
    st.markdown("### ğŸ›Œ Popular Sleep Methods - Detailed Breakdown")
    
    cols = st.columns(min(3, len(methods_counts)))
    for idx, (method, count) in enumerate(methods_counts.items()):
        with cols[idx % 3]:
            percentage = (count / len(df)) * 100
            st.metric(
                label=method if len(method) < 35 else method[:32] + "...",
                value=count,
                delta=f"{percentage:.1f}% of students"
            )
    
    with st.expander("ğŸ’¡ Evidence-Based Sleep Hygiene Practices"):
        st.markdown("""
        ### ğŸŒ™ Scientifically Proven Methods for Better Sleep:
        
        **Environmental Factors:**
        - ğŸŒ¡ï¸ Keep bedroom temperature between 60-67Â°F (15-19Â°C)
        - ğŸ”‡ Use white noise or earplugs to block disruptive sounds
        - ğŸŒ‘ Ensure complete darkness with blackout curtains
        - ğŸ›ï¸ Invest in comfortable mattress and pillows
        
        **Behavioral Strategies:**
        - ğŸ“… Maintain consistent sleep-wake schedule (even weekends)
        - ğŸµ Listen to calming music or nature sounds (60-80 BPM)
        - ğŸ“š Read physical books (not on screens)
        - ğŸ§˜ Practice relaxation: meditation, deep breathing, progressive muscle relaxation
        
        **What to Avoid:**
        - â˜• No caffeine 6+ hours before bedtime
        - ğŸ“± Avoid screens 1-2 hours before sleep
        - ğŸ½ï¸ Don't eat heavy meals 3 hours before bed
        - ğŸƒ Avoid vigorous exercise close to bedtime
        
        **When to Seek Help:**
        If sleep problems persist for more than 2 weeks, consult a healthcare professional.
        """)
    
    st.markdown("---")
    
    # Summary Section
    st.markdown("## ğŸ“ Comprehensive Analysis Summary")
    st.success("""
    **ğŸ” Key Findings from Member 3's Analysis:**
    
    âœ… **Device Usage**: Overwhelming majority use electronics before sleep - major concern  
    âœ… **Caffeine Dependency**: Significant reliance on caffeine indicates sleep debt compensation  
    âœ… **Physical Activity**: Wide variation suggests opportunity for intervention  
    âœ… **Stress Levels**: High academic stress strongly correlates with sleep issues  
    âœ… **Sleep Methods**: Students are actively seeking solutions but need guidance  
    
    **ğŸ’¡ Evidence-Based Recommendations:**
    
    ğŸ¯ **Immediate Actions:**
    1. Implement campus-wide digital sunset campaign (1 hour before bed)
    2. Reduce caffeine availability after 3 PM in campus facilities
    3. Promote free exercise programs and gym access
    4. Establish peer support groups for stress management
    
    ğŸ¯ **Long-term Interventions:**
    1. Integrate sleep education into freshman orientation
    2. Provide cognitive behavioral therapy for insomnia (CBT-I)
    3. Create quiet study spaces conducive to rest
    4. Implement flexible examination schedules during high-stress periods
    
    **ğŸ“Š Expected Outcomes:**
    - 30-40% improvement in sleep quality within 8 weeks
    - Reduced daytime fatigue and improved concentration
    - Better academic performance and overall wellbeing
    """)
    
    # Navigation
    st.markdown("---")
    st.markdown("### ğŸ§­ Continue Exploring")
    col1, col2, col3 = st.columns(3)
    with col1:
        if st.button("â¬…ï¸ View Member 2", use_container_width=True):
            st.switch_page("pages/2_ğŸ‘¤_Member_2_Analysis.py")
    with col2:
        if st.button("ğŸ  Back to Home", use_container_width=True):
            st.switch_page("app.py")
    with col3:
        if st.button("â¬…ï¸ View Member 1", use_container_width=True):
            st.switch_page("pages/1_ğŸ‘¤_Member_1_Analysis.py")

else:
    st.error("Unable to load data. Please check your connection and try refreshing.")

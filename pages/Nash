import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go

# Page configuration
st.set_page_config(
    page_title="Member 3 Analysis",
    page_icon="ðŸ‘¤",
    layout="wide"
)

# Custom CSS
st.markdown("""
    <style>
    [data-testid="stSidebar"] {
        background: linear-gradient(180deg, #1e3a8a 0%, #3b82f6 100%);
    }
    h1 {
        color: #1e3a8a;
        font-weight: 700;
        padding-bottom: 1rem;
        border-bottom: 3px solid #3b82f6;
    }
    </style>
""", unsafe_allow_html=True)

# Google Sheets CSV URL
CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSf4umx6QNDel99If8P2otizAHj7jEDxFIsqandbD0zYVzfDheZo2YVkK1_zknpDKjHnBuYWCINgcCe/pub?output=csv"

# Load data
@st.cache_data(ttl=300)
def load_data():
    try:
        df = pd.read_csv(CSV_URL)
        return df
    except Exception as e:
        st.error(f"Error loading data: {e}")
        return None

df = load_data()

# Page Header
st.title("ðŸ‘¤ Member 3: Lifestyle Factors & Sleep Habits Analysis")
st.markdown("### Investigating Behavioral and Environmental Influences on Sleep")
st.markdown("---")

if df is not None:
    # Visualization 1: Electronic Device Usage
    st.markdown("## ðŸ“Š Visualization 1: Electronic Device Usage Before Sleep")
    st.markdown("*Screen time habits before bedtime*")
    
    col1, col2 = st.columns([3, 2])
    
    with col1:
        device_counts = df['How often do you use electronic devices (e.g., phone, computer) before going to sleep? '].value_counts()
        fig1 = px.pie(
            values=device_counts.values, 
            names=device_counts.index,
            title="Electronic Device Usage Before Bedtime",
            color_discrete_sequence=px.colors.qualitative.Set1,
            hole=0.4
        )
        fig1.update_traces(textposition='inside', textinfo='percent+label')
        fig1.update_layout(height=450)
        st.plotly_chart(fig1, use_container_width=True)
    
    with col2:
        st.markdown("### ðŸ“± Usage Patterns")
        st.markdown("---")
        for category, count in device_counts.items():
            percentage = (count / len(df)) * 100
            if category == "Always (every night)":
                st.error(f"**{category}**: {count} ({percentage:.1f}%)")
            elif "Often" in category or "Frequently" in category:
                st.warning(f"**{category}**: {count} ({percentage:.1f}%)")
            else:
                st.success(f"**{category}**: {count} ({percentage:.1f}%)")
    
    with st.expander("ðŸ’¡ Why This Matters"):
        st.write("""
        Blue light from screens can suppress melatonin production, making it harder to fall asleep.
        Excessive device usage before bed is linked to:
        - Delayed sleep onset
        - Reduced sleep quality
        - Disrupted circadian rhythm
        """)
    
    st.markdown("---")
    
    # Visualization 2: Caffeine Consumption
    st.markdown("## ðŸ“Š Visualization 2: Caffeine Consumption Patterns")
    st.markdown("*How often students consume caffeine to stay awake or alert*")
    
    caffeine_counts = df['How often do you consume caffeine (coffee, energy drinks) to stay awake or alert? '].value_counts()
    
    fig2 = px.bar(
        x=caffeine_counts.index, 
        y=caffeine_counts.values,
        title="Caffeine Consumption Frequency",
        color=caffeine_counts.values,
        color_continuous_scale='Teal',
        labels={'x': 'Frequency', 'y': 'Number of Students'}
    )
    fig2.update_layout(height=450, showlegend=False)
    st.plotly_chart(fig2, use_container_width=True)
    
    col1, col2, col3 = st.columns(3)
    with col1:
        high_caffeine = caffeine_counts.get('Always (every night)', 0) + caffeine_counts.get('Often (5â€“6 times a week)', 0)
        st.metric("â˜• High Users", high_caffeine, delta="Daily/Often")
    with col2:
        moderate_caffeine = caffeine_counts.get('Sometimes (3â€“4 times a week)', 0)
        st.metric("â˜• Moderate Users", moderate_caffeine, delta="3-4x/week")
    with col3:
        low_caffeine = caffeine_counts.get('Rarely (1â€“2 times a week)', 0) + caffeine_counts.get('Never', 0)
        st.metric("â˜• Low/No Users", low_caffeine, delta="Rare/Never")
    
    st.markdown("---")
    
    # Visualization 3: Physical Activity
    st.markdown("## ðŸ“Š Visualization 3: Physical Activity & Exercise Frequency")
    st.markdown("*Regular exercise habits among students*")
    
    exercise_counts = df['How often do you engage in physical activity or exercise? '].value_counts()
    
    # Create ordered categories
    order = ['Never', 'Rarely (1â€“2 times a week)', 'Sometimes (3â€“4 times a week)', 
             'Often (5â€“6 times a week)', 'Every day']
    exercise_ordered = exercise_counts.reindex([cat for cat in order if cat in exercise_counts.index], fill_value=0)
    
    fig3 = go.Figure()
    fig3.add_trace(go.Bar(
        x=exercise_ordered.index,
        y=exercise_ordered.values,
        marker=dict(
            color=['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e'],
            line=dict(color='white', width=2)
        ),
        text=exercise_ordered.values,
        textposition='outside'
    ))
    
    fig3.update_layout(
        title="Exercise Frequency Among Students",
        xaxis_title="Frequency",
        yaxis_title="Number of Students",
        height=500,
        xaxis_tickangle=-45
    )
    st.plotly_chart(fig3, use_container_width=True)
    
    st.info("""
    **ðŸ’ª Exercise & Sleep Connection:**
    Regular physical activity can improve sleep quality by:
    - Reducing stress and anxiety
    - Regulating circadian rhythm
    - Promoting deeper sleep stages
    - Reducing time to fall asleep
    """)
    
    st.markdown("---")
    
    # Visualization 4: Stress Levels
    st.markdown("## ðŸ“Š Visualization 4: Academic Stress Levels")
    st.markdown("*Stress related to academic workload*")
    
    col1, col2 = st.columns([2, 3])
    
    with col1:
        st.markdown("### ðŸ“Š Stress Distribution")
        stress_counts = df['How would you describe your stress levels related to academic workload? '].value_counts()
        
        for category, count in stress_counts.items():
            percentage = (count / len(df)) * 100
            st.write(f"**{category}**")
            
            if "high" in category.lower():
                st.progress(percentage / 100, text=f"{percentage:.1f}%")
                st.error(f"{count} students")
            elif "moderate" in category.lower():
                st.progress(percentage / 100, text=f"{percentage:.1f}%")
                st.warning(f"{count} students")
            else:
                st.progress(percentage / 100, text=f"{percentage:.1f}%")
                st.success(f"{count} students")
            st.write("")
    
    with col2:
        fig4 = px.pie(
            values=stress_counts.values, 
            names=stress_counts.index,
            title="Stress Levels Related to Academic Workload",
            color_discrete_sequence=px.colors.qualitative.Pastel
        )
        fig4.update_traces(textposition='auto', textinfo='percent+label')
        fig4.update_layout(height=450)
        st.plotly_chart(fig4, use_container_width=True)
    
    st.markdown("---")
    
    # Visualization 5: Sleep Methods
    st.markdown("## ðŸ“Š Visualization 5: Sleep Aid Methods Used")
    st.markdown("*Techniques students use to improve their sleep*")
    
    methods_counts = df['Do you use any methods to help you sleep?'].value_counts()
    
    fig5 = px.bar(
        x=methods_counts.index, 
        y=methods_counts.values,
        title="Methods Used to Help Sleep",
        color=methods_counts.values,
        color_continuous_scale='Oranges',
        labels={'x': 'Method', 'y': 'Number of Students'}
    )
    fig5.update_layout(
        height=500,
        xaxis_tickangle=-45,
        showlegend=False
    )
    st.plotly_chart(fig5, use_container_width=True)
    
    # Methods breakdown
    st.markdown("### ðŸ›Œ Popular Sleep Methods")
    
    cols = st.columns(3)
    for idx, (method, count) in enumerate(methods_counts.items()):
        with cols[idx % 3]:
            percentage = (count / len(df)) * 100
            st.metric(
                label=method if len(method) < 30 else method[:27] + "...",
                value=count,
                delta=f"{percentage:.1f}% of students"
            )
    
    with st.expander("ðŸ’¡ Recommended Sleep Hygiene Practices"):
        st.write("""
        **Effective Methods for Better Sleep:**
        - ðŸŽµ Listening to calming music or white noise
        - ðŸ“µ Avoiding screens 1-2 hours before bed
        - ðŸ§˜ Practicing relaxation techniques (meditation, deep breathing)
        - ðŸ“š Reading (physical books, not on screens)
        - â˜• Avoiding caffeine 4-6 hours before bedtime
        - ðŸƒ Regular exercise (but not too close to bedtime)
        - ðŸŒ¡ï¸ Keeping bedroom cool and dark
        - â° Maintaining consistent sleep schedule
        """)
    
    st.markdown("---")
    
    # Summary Section
    st.markdown("## ðŸ“ Analysis Summary")
    st.success("""
    **Key Findings from Member 3's Analysis:**
    - High prevalence of electronic device usage before sleep affects sleep quality
    - Caffeine consumption patterns show dependency on stimulants for alertness
    - Physical activity levels vary widely, with potential for improvement
    - Academic stress is a significant factor affecting sleep
    - Students employ various methods to improve sleep, but effectiveness varies
    - Lifestyle modifications could significantly improve sleep outcomes
    
    **Recommendations:**
    - Implement digital curfew 1-2 hours before bedtime
    - Reduce caffeine intake, especially in afternoon/evening
    - Increase regular physical activity
    - Develop stress management strategies
    - Educate on evidence-based sleep hygiene practices
    """)

else:
    st.error("Unable to load data. Please check your connection and try refreshing.")

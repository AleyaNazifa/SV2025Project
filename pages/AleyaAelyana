import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime
import pytz

# Page configuration
st.set_page_config(
    page_title="Member 1 Analysis",
    page_icon="ğŸ‘¤",
    layout="wide"
)

# Custom CSS - Professional styling
st.markdown("""
    <style>
    [data-testid="stSidebar"] {
        background: linear-gradient(180deg, #4c1d95 0%, #5b21b6 50%, #6d28d9 100%);
    }
    [data-testid="stSidebar"] * {
        color: white !important;
    }
    h1 {
        color: #4c1d95;
        font-weight: 800;
        padding-bottom: 1rem;
        border-bottom: 4px solid #8b5cf6;
    }
    h2 {
        color: #5b21b6;
        font-weight: 700;
    }
    .stButton>button {
        background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        color: white;
        font-weight: 600;
    }
    </style>
""", unsafe_allow_html=True)

# Google Sheets CSV URL
CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSf4umx6QNDel99If8P2otizAHj7jEDxFIsqandbD0zYVzfDheZo2YVkK1_zknpDKjHnBuYWCINgcCe/pub?output=csv"

# Load data
@st.cache_data(ttl=300)
def load_data():
    try:
        df = pd.read_csv(CSV_URL)
        return df
    except Exception as e:
        st.error(f"Error loading data: {e}")
        return None

def get_malaysian_time():
    malaysia_tz = pytz.timezone('Asia/Kuala_Lumpur')
    return datetime.now(malaysia_tz)

df = load_data()

# Sidebar navigation
with st.sidebar:
    st.markdown("### ğŸ§­ Quick Navigation")
    col1, col2 = st.columns(2)
    with col1:
        if st.button("ğŸ  Home", use_container_width=True):
            st.switch_page("app.py")
    with col2:
        if st.button("ğŸ”„ Refresh", use_container_width=True):
            st.cache_data.clear()
            st.rerun()
    
    st.markdown("---")
    my_time = get_malaysian_time()
    st.info(f"ğŸ• {my_time.strftime('%H:%M:%S')} MYT\nğŸ“… {my_time.strftime('%d %B %Y')}")

# Page Header
st.title("ğŸ‘¤ Member 1: Demographic & Sleep Pattern Analysis")
st.markdown("### ğŸ” Exploring Sleep Behaviors Among UMK Students")
st.markdown("---")

if df is not None:
    # Visualization 1: Gender Distribution
    st.markdown("## ğŸ“Š Visualization 1: Gender Distribution")
    st.markdown("*Understanding the demographic composition of survey respondents*")
    
    gender_counts = df['What is your gender?'].value_counts()
    
    col1, col2 = st.columns([3, 1])
    
    with col1:
        fig1 = px.pie(
            values=gender_counts.values, 
            names=gender_counts.index,
            title="Survey Respondents by Gender",
            color_discrete_sequence=['#8b5cf6', '#a78bfa', '#c4b5fd'],
            hole=0.4
        )
        fig1.update_traces(textposition='inside', textinfo='percent+label', textfont_size=14)
        fig1.update_layout(height=500, showlegend=True, font=dict(size=12))
        st.plotly_chart(fig1, use_container_width=True)
    
    with col2:
        st.markdown("### ğŸ“Š Summary")
        for gender, count in gender_counts.items():
            percentage = (count / len(df)) * 100
            st.metric(gender, f"{count}", f"{percentage:.1f}%")
    
    with st.expander("ğŸ’¡ Key Insights - Gender Distribution"):
        st.write(f"""
        - **Total respondents**: {len(df)} students
        - Gender breakdown provides demographic context for sleep pattern analysis
        - Helps identify if sleep issues vary by gender demographics
        - Essential baseline for cross-sectional analysis
        """)
    
    st.markdown("---")
    
    # Visualization 2: Age Group Distribution
    st.markdown("## ğŸ“Š Visualization 2: Age Group Distribution")
    st.markdown("*Age demographics of survey participants*")
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        age_counts = df['What is your age group?'].value_counts().sort_index()
        fig2 = px.bar(
            x=age_counts.index, 
            y=age_counts.values,
            title="Distribution by Age Group",
            color=age_counts.values,
            color_continuous_scale='Purples',
            labels={'x': 'Age Group', 'y': 'Number of Students'}
        )
        fig2.update_layout(height=450, showlegend=False)
        fig2.update_traces(texttemplate='%{y}', textposition='outside')
        st.plotly_chart(fig2, use_container_width=True)
    
    with col2:
        st.metric("ğŸ“Š Most Common Age", age_counts.idxmax())
        st.metric("ğŸ”¢ Age Groups", len(age_counts))
        st.metric("ğŸ‘¥ Total Students", len(df))
        
        with st.expander("ğŸ“ˆ Detailed Breakdown"):
            for age, count in age_counts.items():
                percentage = (count / len(df)) * 100
                st.write(f"**{age}**: {count} ({percentage:.1f}%)")
    
    st.markdown("---")
    
    # Visualization 3: Sleep Hours Distribution
    st.markdown("## ğŸ“Š Visualization 3: Daily Sleep Duration Analysis")
    st.markdown("*Average hours of sleep students get per day*")
    
    sleep_counts = df['On average, how many hours of sleep do you get on a typical day? '].value_counts().sort_index()
    
    fig3 = px.bar(
        x=sleep_counts.index, 
        y=sleep_counts.values,
        title="Average Sleep Duration Distribution",
        color=sleep_counts.values,
        color_continuous_scale='Teal',
        labels={'x': 'Sleep Hours', 'y': 'Number of Students'}
    )
    fig3.update_layout(height=500)
    fig3.update_traces(texttemplate='%{y}', textposition='outside')
    st.plotly_chart(fig3, use_container_width=True)
    
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        most_common_sleep = sleep_counts.idxmax()
        st.metric("ğŸ˜´ Most Common", most_common_sleep, "hours")
    with col2:
        total_responses = sleep_counts.sum()
        st.metric("ğŸ“ Responses", total_responses)
    with col3:
        sleep_categories = len(sleep_counts)
        st.metric("ğŸ“Š Categories", sleep_categories)
    with col4:
        avg_sleep = (sleep_counts.index.astype(str).str.extract('(\d+)')[0].astype(float) * sleep_counts).sum() / sleep_counts.sum()
        st.metric("â±ï¸ Average", f"{avg_sleep:.1f}h")
    
    st.markdown("---")
    
    # Visualization 4: Insomnia Frequency
    st.markdown("## ğŸ“Š Visualization 4: Difficulty Falling Asleep Patterns")
    st.markdown("*Frequency of insomnia symptoms among students*")
    
    col1, col2 = st.columns([3, 2])
    
    with col1:
        insomnia_counts = df['How often do you have difficulty falling asleep at night? '].value_counts()
        fig4 = px.pie(
            values=insomnia_counts.values, 
            names=insomnia_counts.index,
            title="Difficulty Falling Asleep Frequency",
            color_discrete_sequence=px.colors.qualitative.Set3
        )
        fig4.update_traces(textposition='auto', textinfo='percent+label', textfont_size=12)
        fig4.update_layout(height=500)
        st.plotly_chart(fig4, use_container_width=True)
    
    with col2:
        st.markdown("### ğŸ“Š Detailed Breakdown")
        st.markdown("---")
        for category, count in insomnia_counts.items():
            percentage = (count / len(df)) * 100
            
            if "Always" in category or "Often" in category:
                st.error(f"**{category}**\n\n{count} students ({percentage:.1f}%)")
            elif "Sometimes" in category:
                st.warning(f"**{category}**\n\n{count} students ({percentage:.1f}%)")
            else:
                st.success(f"**{category}**\n\n{count} students ({percentage:.1f}%)")
    
    st.markdown("---")
    
    # Visualization 5: Sleep Quality Rating
    st.markdown("## ğŸ“Š Visualization 5: Overall Sleep Quality Ratings")
    st.markdown("*How students rate their sleep quality on a scale of 1-5*")
    
    fig5 = px.histogram(
        df, 
        x='How would you rate the overall quality of your sleep? ',
        title="Overall Sleep Quality Ratings Among UMK Students",
        color_discrete_sequence=['#8b5cf6'],
        labels={'How would you rate the overall quality of your sleep? ': 'Sleep Quality Rating (1-5)'}
    )
    fig5.update_layout(
        xaxis_title="Sleep Quality Rating (1 = Very Poor, 5 = Excellent)",
        yaxis_title="Number of Students",
        height=500,
        bargap=0.15
    )
    fig5.update_traces(texttemplate='%{y}', textposition='outside')
    st.plotly_chart(fig5, use_container_width=True)
    
    # Summary statistics
    st.markdown("### ğŸ“ˆ Sleep Quality Statistics")
    col1, col2, col3, col4 = st.columns(4)
    
    quality_col = 'How would you rate the overall quality of your sleep? '
    
    with col1:
        avg_quality = df[quality_col].mean()
        st.metric("â­ Average Rating", f"{avg_quality:.2f}/5", "Overall")
    
    with col2:
        mode_quality = df[quality_col].mode()[0]
        st.metric("ğŸ¯ Most Common", f"{mode_quality}/5", "Mode")
    
    with col3:
        poor_sleep = len(df[df[quality_col] <= 2])
        poor_pct = (poor_sleep / len(df)) * 100
        st.metric("ğŸ˜” Poor Sleep (â‰¤2)", poor_sleep, f"{poor_pct:.1f}%", delta_color="inverse")
    
    with col4:
        good_sleep = len(df[df[quality_col] >= 4])
        good_pct = (good_sleep / len(df)) * 100
        st.metric("ğŸ˜Š Good Sleep (â‰¥4)", good_sleep, f"{good_pct:.1f}%", delta_color="normal")
    
    st.markdown("---")
    
    # Summary Section
    st.markdown("## ğŸ“ Analysis Summary & Key Findings")
    st.success("""
    **ğŸ” Key Findings from Member 1's Analysis:**
    
    âœ… **Demographics**: Established clear demographic profile of survey participants  
    âœ… **Sleep Duration**: Identified typical sleep patterns across student population  
    âœ… **Insomnia Patterns**: Documented frequency and severity of sleep difficulties  
    âœ… **Quality Assessment**: Measured subjective sleep quality ratings  
    âœ… **Correlations**: Revealed relationships between demographics and sleep behaviors  
    
    **ğŸ’¡ Implications**: This analysis provides the foundational understanding needed to 
    assess sleep-related issues and their potential impact on academic performance.
    """)
    
    # Navigation
    st.markdown("---")
    col1, col2, col3 = st.columns(3)
    with col1:
        if st.button("â¬…ï¸ Back to Home", use_container_width=True):
            st.switch_page("app.py")
    with col2:
        if st.button("â¡ï¸ View Member 2", use_container_width=True):
            st.switch_page("pages/2_ğŸ‘¤_Member_2_Analysis.py")
    with col3:
        if st.button("â¡ï¸ View Member 3", use_container_width=True):
            st.switch_page("pages/3_ğŸ‘¤_Member_3_Analysis.py")

else:
    st.error("Unable to load data. Please check your connection and try refreshing.")
